# Installation of Perturbo
Installing Perturbo can be complicated due to the fact that it depends on other packages, such as Quantum Espresso, HDF5, LAPACK, etc.
Therefore, there are 2 scenarios for installing our package - from scratch (which was covered on the first day in the first tutorial) and using containers. During the workshop you will use the second method, so now we will take a closer look at it.

## Usage of containers

It is possible to run perturbo faster and easier if you use soft called Docker. This will not be a universal solution, but it will allow you to get acquainted with the functionality of the package, as well as to run programs that are not computationally intensive.

### About Docker and containers
Docker is a set of platform as a service (PaaS) products that use OS-level virtualization to deliver software in packages called containers. 

So Docker is just the name of the software that allows you to use things called containers. Accordingly, we need to understand what containers are. 
![Containers vs. virtual machine](https://github.com/perturbo-code/perturbo-workshop-2023/blob/main/Hands-on1/images/docker_def.png)

Let's consider a container versus a virtual machine. In the latter case, we have several separate operating systems running, managed by a hypervisor. In this case, each OS is independent and exists on its own, they are completely separated from each other.

A container, on the other hand, uses the kernel of the host operating system, and on its basis runs a "micro-OS", inside which there are only a few necessary applications. This allows you to get an environment with applications installed in it and start using it quite quickly without large memory and computational costs.

For example, if we're talking about `perturbo/perturbo:gcc`, this image (more on that below) consists of:

1. Ubuntu shell
2. The built gcc compiler
3. Some supplementary staff (`vim`, `unzip`, etc.)
3. the HDF5 and Quantum Espresso packages
4. Perturbo package

![perturbo/perturbo:gcc](https://github.com/perturbo-code/perturbo-workshop-2023/blob/main/Hands-on1/images/perturbo_gcc.png)

Accordingly, by running a container of this image (more on this below) on any computer running [Docker](https://www.docker.com) or its analogs (such as [Podman](https://podman.io)), you will be able to perform calculations using `Perturbo`, avoiding compilation. That's the point of containerization - to create an image ready to use.

### Basic concepts:

1. Image is a "mini-OS" that will be used. It is these images that are hosted on the [docker hub](https://hub.docker.com), where you can find images for many different applications. That's where the name of our images comes from. In this case, what comes before the slash is the name of the repository owner, after the slash is the name of the repository itself, and after the colon is the image tag. So the name [**perturbo/perturbo:gcc**](https://hub.docker.com/repository/docker/perturbo/perturbo/general) can be understood as "The image of the perturbo user from the perturbo repository with the *gcc* tag" 
2. Container - is an instance of a "virtual machine" that is created from an existing image. It is in the created container that your work is done. The relationship between an image and a container is similar to the relationship between a class and its instance. The class defines general characteristics, while we work with instances of the class. Here the essence is the same.

While a container is simply an instance built from an image, the image itself can be used in different ways. It can be used to create new containers as well as to create new images. For example, the Perturbo image is built in two stages - first, the supplementary [Docker Images](https://hub.docker.com/repository/docker/perturbo/perturbo_suppl/general) (containing all the supplementary libraries). The supplementary images take [Ubuntu](https://hub.docker.com/_/ubuntu)images as their base.

3. Volumes - are the preferred mechanism for persisting data generated by and used by Docker containers. The idea is that when each container is created, a corresponding volume is created. By default, such volumes are deleted when the container itself is deleted. This is inconvenient if we need to save some files from the container. Below is how to avoid this.

Visit https://docker-curriculum.com for more information.

### Run the Docker on your computer 
If you want to use builded images on your computer, you will need to follow these steps:

1. Install the [Docker](https://www.docker.com) application on your computer;
2. Clone the Image from the [Docker Hub of the Perturbo](https://hub.docker.com/repository/docker/perturbo/perturbo/general). You can find the command for pulling the images on the tab **Tags**. For example, for GCC case it would be:
	```bash
	docker pull perturbo/perturbo:gcc
	```
	You can use this container because it is light enough and it is also well suited for computers with ARM64 processors (Macs with M1/M2). In case of computers with Intel processors, a good solution is to use the *ifort_openmp* container, which supports parallelization.
3. Let's verify that you do indeed have a new image:
	```bash
	docker images
	```
	It's expected to obtain something like that:
	```bash
	REPOSITORY          TAG                IMAGE ID       CREATED        SIZE
	perturbo/perturbo   gcc                b68664b8a5f9   5 hours ago    4.38GB
	```

3. Run the following command:
	```bash
	docker run -v name_of_your_work_folder:/home/user/run/name_of_your_work_folder_in_container -it -h perturbocker --rm --name perturbo perturbo/perturbo:tag
	```
This command has the following meaning:
1. `-v` - V for ~~Vendetta~~ Volumes, which we talked about earlier. To connect a folder on your primary OS to a folder inside the container, specify the name of the folder on your computer, and after the colon, what the same volume inside the container will be called. In this case, the changes that will happen to the volume inside the container will be reflected in your OS and vice versa. This allows you to not only transfer input files to the container, but also to save all output-files after the container is finished and the container itself is deleted; 
2. `-it` - interactive launch of the container, so that we can go inside and run some calculations there. Without this command, the container would start and close immediately, since no execution is defined in it;
3. `-h perturbocker` - is the hostname of the container. By default, it is the same as the container ID, which may not be particularly informative or readable. So we give it a specific name;
4. `--rm` - deletes the container after its use is finished. Made to save memory. If it is important for you to save the container itself (for example, if you have installed any packages there), this option should be removed, and the container should be started using [`docker start`](https://docs.docker.com/engine/reference/commandline/start/) in the future. 
5. `--name` - the name that the container will receive. During run (and, if the container is not deleted, during storage) it can be referred to by this name. 

Full list of the command line options is provided on the [offical page](https://docs.docker.com/engine/reference/commandline/run/).

You need to change two parameters:

1. The names of your volume and folder in the container;
2. The name of the image itself - instead of `tag` specify the tag of the image you want to use as a basis for creating the container.

Now you're inside the container, congratulations! If you want to use perturbo, all you have to do is type in the terminal

```bash 
perturbo.x 
```

And you will see the program start up.

Similarly with Quantum Espresso executables.

Now you are ready for the usage of Perturbo in the container form!
