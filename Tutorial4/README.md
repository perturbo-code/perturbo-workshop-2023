# Tutorial4 Ultrafast Carrier Dynamics
We will demonstrate simulation of ultrafast carrier dynamics with Perturbo with the example of graphene.

The necessary graphene_epr.h5 file can be found listed in "[other examples](https://perturbo-code.github.io/mydoc_tutorial_graphene.html)" on the Perturbo website, with the direct box link to the folder for epr.h5 from [here](https://caltech.app.box.com/s/2ael37t601nzhnmdxbvbgr3dt1ax7aff/folder/101224307573).

### Setting the environment 
First create a folder. The folder should contain prefix_epr.h5 file, as well as plot_dyna.py script found in this folder in the repository.

Set up [docker environment](https://github.com/perturbo-code/perturbo-workshop-2023/tree/main/Hands-on1) for Perturbo.


```bash
export DYNADIR=$(pwd)
docker run -v $DYNADIR:/home/user/run/dynamics
--user 500 -it -h perturbodocker --rm --name perturbo perturbo/perturbo:gcc_openmp

cd dynamics
```

Then set OpenMP commands (if used)
```bash
export OMP_NUM_THREADS=4
```

### Description of the example problem

First, we model the cooling of photoexcited electrons in graphene at room temperature. 

For typical pump-probe experiments, shortly after the excitation, electrons can be described by a hot Fermi-Dirac distribution with a temperature of a few thousand degrees. Therefore, we initialize the electron-phonon system with the optically excited electrons in a thermal equilibrium at 1700 Kelvin. 

From $t=0$, we simulate the dynamics of the electron populations cooled in a phonon bath of 300K. Phonon populations in this simulation are set to be time-independent. The carrier concentration is set as $1.0\times10^{13} \mathrm{cm}^{-2}$.

All the reference results can be found under References folder within each folder.

### Setting up momentum grids with setup
prefix_epr.h5 is currently saved in the general directory and we will use soft-linking to access it.

```bash!
mkdir pert-setup
cd pert-setup
```

First, link prefix_epr file.

```bash
ln -sf ../graphene_epr.h5
```

Edit graphene.temper file for a given carrier concentration and phonon bath temperature.

```bash=
1         
300.0     0.0     1.0E+13
```

Create a new input file pert.in
```bash!
vim pert.in
```

From the [interative workflow](https://perturbo-code.github.io/mydoc_interactive_workflow.html) for setup, copy the information into the input file pert.in, and edit input parameters.

```bash=
&perturbo
! ***Mandatory parameters***
 calc_mode          = 'setup'
 prefix             = 'graphene'
 boltz_kdim(1)      = 400
 boltz_kdim(2)      = 400
 boltz_kdim(3)      = 1
 ftemper            = 'graphene.temper'
 
! ***Optional parameters***
 find_efermi        = .true.
 band_min           = 2
 band_max           = 2
 boltz_emin         = -4.93        ! eV
 boltz_emax         = -3.53        ! eV
 hole               = .false.
/
```

Set find_efermi = .true. to determine the chemical potential. Although, in dynamics-run, the only used variables in prefix.temper are the line number 1 and the phonon bath temperature.


Run setup calculation
```bash
perturbo.x -i pert.in | tee pert.out
```


### Running dynamics with dynamics-run
 
```bash!
cd ../
mkdir pert-dyna-run
cd pert-dyna-run
```

Link prefix_epr.h5 file
```bash
ln -sf ../graphene_epr.h5
```

Copy prefix_tet.h5, prefix.temper file to the current directory.
```bash
cp ../pert-setup/graphene_tet.h5 .
cp ../pert-setup/graphene.temper .
```

Create a new input file pert.in
```bash!
vim pert.in
```

From the [interative workflow](https://perturbo-code.github.io/mydoc_interactive_workflow.html) for dynamics-run, copy the information into the input file pert.in, and edit input parameters.

```bash=
! This input file for PERTURBO was generated by generate_input.py script

&perturbo
! ***Mandatory parameters***
 calc_mode           = 'dynamics-run'
 prefix              = 'graphene'
 boltz_kdim(1)       = 400
 boltz_kdim(2)       = 400
 boltz_kdim(3)       = 1
 ftemper             = 'graphene.temper'
 boltz_nstep         = 100
 output_nstep        = 10
 time_step           = 1.0             ! fs
 boltz_init_dist     = 'fermi'


! ***Optional parameters***
 solver             = 'euler'
 boltz_init_e0      = -4.2281057129     ! eV
 boltz_init_smear   = 146.57            ! meV
 delta_smear        = 10.0              ! meV
 phfreq_cutoff      = 1.0               ! meV
 boltz_qdim(1)      = 200
 boltz_qdim(2)      = 200
 boltz_qdim(3)      = 1
 hole               = .false.
 band_min           = 2
 band_max           = 2
 boltz_emin         = -4.93         ! eV
 boltz_emax         = -3.53          ! eV
 load_scatter_eph   = .false.
 tmp_dir            = './tmp'
/
```

Run dynamics calculation
```bash
perturbo.x -i pert.in | tee pert.out
```

Look at result graphene_cdyna.h5
```bash
h5ls graphene_cdyna.h5
```
Look at yaml output file.

```bash
vim graphene_dynamics-run.yml
```

### Restart dynamics-run
One can restart the dynamics run from the end of the previous run. Copy pert-dynamics run input file pert.in to pert-restart.in

```bash
cp pert.in pert-restart.in
```

In pert-restart.in, change the following lines
```bash=
 boltz_init_dist     = 'restart'
 load_scatter_eph    = .true.
```
Then change the time step size, number of time steps as desired, integration methods as desired.
```bash=
 boltz_nstep         = 180
 output_nstep        = 4
 time_step           = 5.0             ! fs
 solver              = 'rk4'
```

Run dynamics calculation again with the new input file, with prefix_cdyna.h5 file from the first run in the same directory.
```bash
perturbo.x -i pert-restart.in | tee pert-restart.out
```

Now prefix_cdyna.h5 file is updated.

### Post-processing with dynamics-pp

```bash!
cd ../
mkdir pert-dyna-pp
cd pert-dyna-pp
```
Copy prefix_tet.h5, prefix.temper file to the current directory, link the epr file. And copy prefix_cdyna.h5 file from folder pert-dyna-run. 
```bash
cp ../pert-setup/graphene_tet.h5 .
cp ../pert-setup/graphene.temper .
ln -sf ../graphene_epr.h5

cp ../pert-dyna-run/graphene_cdyna.h5 .
```

Create a new input file pp.in
```bash!
vim pp.in
```

From the [interative workflow](https://perturbo-code.github.io/mydoc_interactive_workflow.html) for dynamics-pp, copy the information into the input file pp.in, and edit input parameters.

Note than one can also save time by copying the input file from 'setup' or 'dynamics-run' folder, and then editing the corresponding parameters. In this case, one needs to change calc-mode to 'dynamics-pp'. 
```bash=
&perturbo
! ***Mandatory parameters***
 calc_mode           = 'dynamics-pp'
 prefix              = 'graphene'
 boltz_kdim(1)       = 400
 boltz_kdim(2)       = 400
 boltz_kdim(3)       = 1
 ftemper             = 'graphene.temper'


! ***Optional parameters***
 hole               = .false.
 boltz_de           = 2.0             ! meV
 band_min           = 2
 band_max           = 2
 boltz_emin         = -4.93         ! eV
 boltz_emax         = -3.53          ! eV
! boltz_efield(1)    = 0.0
! boltz_efield(2)    = 0.0
! boltz_efield(3)    = 0.0
/
```

Run post-processing calculation
```bash
perturbo.x -i pp.in | tee pp.out
```

### Result analysis with Perturbopy
Copy plot_dyna.py from the main folder into the folder pert-dyna-pp.
```bash!
cp ../plot_dyna.py .
```

With installed [Perturbopy](https://perturbopy.readthedocs.io/en/latest/index.html) package, run the python script to plot electron populations as a function of energy at various time snapshots.
```bash
python3 plot_dyna.py
```
Then one will be asked to input the number of snapshots to be plotted. Enter a positive integer, for example, 6
```bash!
Enter number of snapshots to be plotted: 6
```
![](https://hackmd.io/_uploads/BksnQKIk6.png)

Note that plot_dyna.py is only a sample script; users can explore other features of python analysis package Perturbopy by creating their own python script. 

One can also readily access and analyze the output of dynamics-run (graphene_cdyna.h5) via Perturbopy. 


### Dynamics with external electric field

In this section, we demonstrate the new feature of dynamics simulation with a nonzero external electric field. We initialize electrons at room temperature, in thermal equilibrium with phonons, then apply a constant external electric field in the transverse direction $E=500 \mathrm{V/cm}$ at $t=0$.

We have prepared the input files for setup, dynamics-run, and dynamics-pp in pert-efield. One can download the files in this repository. Besides, one can also conveniently run all steps of dynamics calculation within the same folder. Here is a demonstration.

First, link epr.file as before
```bash!
cd pert-efield
ln -sf ../graphene_epr.h5
```
Create graphene.temper file
```bash=
1         
300.0     0.0     1.0E+13
```

Run setup calculation, notice that we can use a smaller energy window this time.
```bash!
perturbo.x -i setup.in | tee setup.out
```

Run dynamics with 'fermi' distribution as initial condition for zero number of time steps
```bash!
perturbo.x -i pert_init.in | tee pert_init.out
```

Then run with 'restart' for longer time steps, this time setting a non-zero electric field
```bash!
perturbo.x -i pert_Efield.in | tee pert_Efield.out
```

Run post processing
```bash!
perturbo.x -i pp.in | tee pp.out
```

Copy plot_dyna.py and run to plot electron occupation as a functino of energy. 
```bash!
cp ../plot_dyna.py .
python3 plot_dyna.py
```
![](https://hackmd.io/_uploads/ByckM9816.png)


### Turn off phonon modes

This time, the initial distribution of the electrons is a gaussian centered at the Dirac cone (electrons in the conduction band only). The input files are included in pert-select-phmodes.

```bash!
cd pert-select-phmodes
ln -sf ../graphene_epr.h5
```

Create graphene.temper file
```bash=
1         
300.0     0.0     1.0E+13
```
```bash!
perturbo.x -i setup.in | tee setup.out
perturbo.x -i pert.in | tee pert.out
perturbo.x -i pp.in | tee pp.out
cp ../plot_dyna.py .
python3 plot_dyna.py
```


Similar to the previous case, one can run setup, dynamics-run and dynamics-pp to obtain the following plot
![](https://hackmd.io/_uploads/Bk1oB58Ja.png)

